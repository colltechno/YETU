<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DEK277J82C"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-DEK277J82C');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YETU - ODTÃœ KampÃ¼s Rehberi</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Harita Konteyneri */
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Alt Panel (Bottom Sheet) Stilleri */
        .bottom-sheet {
            position: fixed;
            bottom: -100%; /* BaÅŸlangÄ±Ã§ta ekran dÄ±ÅŸÄ±nda */
            left: 0;
            width: 100%;
            height: 70vh; /* EkranÄ±n %70'ini kaplar */
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            transition: bottom 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

            .bottom-sheet.active {
                bottom: 0;
            }

        /* Panel TutacaÄŸÄ± (SÃ¼rÃ¼kleme hissi iÃ§in) */
        .sheet-handle {
            width: 50px;
            height: 5px;
            background-color: #ddd;
            border-radius: 5px;
            margin: 15px auto;
            flex-shrink: 0;
            position: relative; /* GÃ¶rÃ¼nmez alanÄ± buna hizalamak iÃ§in gerekli */
            touch-action: none; /* TarayÄ±cÄ±nÄ±n kendi kaydÄ±rmasÄ±nÄ± iptal eder */
            cursor: grab;
        }

            /* 2. Ã‡ubuÄŸun EtrafÄ±ndaki GÃ¶rÃ¼nmez Dokunma AlanÄ± (::after) */
            .sheet-handle::after {
                content: "";
                position: absolute;
                /* Ã‡ubuÄŸun her yÃ¶nÃ¼nden 25px dÄ±ÅŸarÄ± taÅŸan gÃ¶rÃ¼nmez bir kutu yaratÄ±yoruz */
                top: -25px;
                bottom: -25px;
                left: -25px;
                right: -25px;
                /* Test etmek iÃ§in aÅŸaÄŸÄ±daki satÄ±rÄ± aÃ§Ä±p kÄ±rmÄ±zÄ± kutuyu gÃ¶rebilirsin: */
                /* background-color: rgba(255, 0, 0, 0.3); */
            }

        /* Ä°Ã§erik AlanÄ± */
        .sheet-content {
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            border: none;
            background: #f0f0f0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }

        /* Mekan Detay Stilleri */
        .venue-header {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .venue-name {
            font-size: 1.5rem;
            color: #333;
        }

        .rating-badge {
            display: inline-block;
            background-color: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* MenÃ¼ KartlarÄ± */
        .menu-item {
            display: flex;
            justify-content: space-between;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            background: #fff;
        }

        .item-details h4 {
            margin-bottom: 4px;
            color: #333;
        }

        .item-desc {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }

        .allergen-tag {
            font-size: 0.7rem;
            background: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
        }

        .price-box {
            text-align: right;
            min-width: 80px;
        }

        .current-price {
            font-weight: bold;
            color: #2c3e50;
        }

        .price-change {
            font-size: 0.7rem;
            color: #e74c3c;
            display: block;
            margin-top: 2px;
        }

        .price-stable {
            color: #27ae60;
        }

        /* Logo AlanÄ± */
        .logo-area {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 999;
            background: white;
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-weight: bold;
            color: #c0392b; /* ODTÃœ KÄ±rmÄ±zÄ±sÄ± tonu */
        }
        /* YÃ¶n Okunun Stili */
        .user-heading-arrow {
            z-index: 1000;
        }
        .user-heading-arrow svg {
                transition: transform 0.2s linear;
        }
        /* Navigasyon Butonu Stili */
        .nav-btn {
            background-color: #2980b9; /* Mavi renk */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Ä°kon ile yazÄ± arasÄ± boÅŸluk */
        }

            .nav-btn:hover {
                background-color: #1f618d;
            }
        /* Bildirim Butonu Stili */
        .report-btn {
            background-color: #f39c12; /* Turuncu renk */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

            .report-btn:hover {
                background-color: #d35400;
            }
        /* --- ARAMA Ã‡UBUÄU STÄ°LLERÄ° --- */
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%); /* Ortalamak iÃ§in */
            width: 90%;
            max-width: 400px; /* Ã‡ok geniÅŸ ekranda dev gibi olmasÄ±n */
            background: white;
            border-radius: 30px; /* Google Maps gibi yuvarlak kenarlar */
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); /* Derinlik gÃ¶lgesi */
            display: flex;
            align-items: center;
            padding: 5px 5px 5px 20px;
            z-index: 2000; /* HaritanÄ±n en Ã¼stÃ¼nde dursun */
        }

        .search-input {
            border: none;
            outline: none;
            flex-grow: 1; /* Kalan boÅŸluÄŸu doldur */
            font-size: 1rem;
            color: #333;
            padding: 10px 0;
        }

        .search-logo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
            object-fit: cover; /* Resmi yuvarlaÄŸa sÄ±ÄŸdÄ±r */
            border: 2px solid #fff; /* Logoya Ã§erÃ§eve */
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }

        /* Arama sonuÃ§larÄ± iÃ§in Ã¶zel etiket */
        .venue-tag {
            font-size: 0.75rem;
            color: #7f8c8d;
            display: block;
            margin-bottom: 2px;
        }
        .user-location-dot {
            background-color: #007bff;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>

    <div class="logo-area">YETU</div>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="YETU ile istediÄŸini bul!">
        <img src="logo.png" class="search-logo" alt="YETU">
    </div>

    <div id="map"></div>

    <div class="bottom-sheet" id="infoPanel">
        <div class="sheet-handle"></div>
        <button class="close-btn" onclick="closePanel()">âœ•</button>

        <div class="sheet-content" id="panelContent">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. HARÄ°TA AYARLARI
        // ODTÃœ kampÃ¼s koordinatlarÄ±na (yaklaÅŸÄ±k kÃ¼tÃ¼phane/Ã§arÅŸÄ± civarÄ±) odaklanÄ±yoruz
        const map = L.map('map').setView([39.8917541320506, 32.78581820941704], 16);

        // OpenStreetMap katmanÄ±nÄ± ekle
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // 2. MOCK DATA
        const venues = [
            {
                id: 1,
                name: "Sunshine Cafe",
                coords: [39.88992749815751, 32.79066032352153],
                rating: 4.2,
                reviews: 128,
                products: [
                    {
                        name: "Tavuklu SandviÃ§",
                        price: 85,
                        oldPrice: 70,
                        ingredients: "Baget ekmek, Ä±zgara tavuk, marul, Ã¶zel sos",
                        allergens: ["Gluten", "Yumurta"],
                        rating: 4.5,
                        lastUpdate: "3 gÃ¼n Ã¶nce"
                    },
                    {
                        name: "Filtre Kahve",
                        price: 45,
                        oldPrice: 45,
                        ingredients: "%100 Arabica Ã§ekirdek",
                        allergens: [],
                        rating: 4.8,
                        lastUpdate: "1 ay Ã¶nce"
                    }
                ]
            },
            {
                id: 2,
                name: "Ã‡atÄ± Restoran",
                coords: [39.89280919127174, 32.782262702338535],
                rating: 4.7,
                reviews: 342,
                products: [
                    {
                        name: "Ã‡atÄ± Burger",
                        price: 180,
                        oldPrice: 150,
                        ingredients: "150gr dana kÃ¶fte, cheddar, karamelize soÄŸan",
                        allergens: ["Gluten", "SÃ¼t ÃœrÃ¼nleri"],
                        rating: 4.9,
                        lastUpdate: "1 hafta Ã¶nce"
                    },
                    {
                        name: "Mercimek Ã‡orbasÄ±",
                        price: 50,
                        oldPrice: 40,
                        ingredients: "KÄ±rmÄ±zÄ± mercimek, tereyaÄŸlÄ± sos",
                        allergens: ["SÃ¼t ÃœrÃ¼nleri"],
                        rating: 4.3,
                        lastUpdate: "2 gÃ¼n Ã¶nce"
                    }
                ]
            },
            {
                id: 3,
                name: "19. Yurt RestoranÄ±",
                coords: [39.885744, 32.777485],
                rating: 4.7,
                reviews: 56,
                products: [
                    {
                        name: "Peperoni Pizza",
                        price: 235, // GÃ¼ncel fiyat
                        oldPrice: 220, // Eski fiyat (Zam okunu iÃ§in)
                        ingredients: "Peperoni, KaÅŸar, Pizza Hamuru",
                        allergens: ["Gluten, SÃ¼t Ã¼rÃ¼nÃ¼"], // Varsa alerjenler
                        rating: 4.2, // ÃœrÃ¼n puanÄ±
                        lastUpdate: "3 hafta Ã¶nce"
                    },
                    {
                        name: "KarÄ±ÅŸÄ±k Pizza",
                        price: 240,
                        oldPrice: 240,
                        ingredients: "MÄ±sÄ±r, Sucuk, Sosis, KaÅŸar, Zeytin, Pizza Hamuru",
                        allergens: ["Gluten, SÃ¼t Ã¼rÃ¼nÃ¼"],
                        rating: 4.7,
                        lastUpdate: "DÃ¼n"
                    },
                    {
                        name: "Mexican Pizza",
                        price: 250, // GÃ¼ncel fiyat
                        oldPrice: 250, // Eski fiyat (Zam okunu iÃ§in)
                        ingredients: "Sucuk, AcÄ± Sos, KaÅŸar, Pizza Hamuru",
                        allergens: ["Gluten, SÃ¼t Ã¼rÃ¼nÃ¼"], // Varsa alerjenler
                        rating: 4.2, // ÃœrÃ¼n puanÄ±
                        lastUpdate: "BugÃ¼n"
                    },
                    {
                        name: "Margarita Pizza",
                        price: 220,
                        oldPrice: 200,
                        ingredients: "KaÅŸar, Pizza Hamuru",
                        allergens: ["Gluten, SÃ¼t Ã¼rÃ¼nÃ¼"],
                        rating: 4.8,
                        lastUpdate: "2 ay Ã¶nce"
                    },
                    {
                        name: "BarbekÃ¼ Pizza",
                        price: 250, // GÃ¼ncel fiyat
                        oldPrice: 250, // Eski fiyat (Zam okunu iÃ§in)
                        ingredients: "Tavuk, BarbekÃ¼ Sos, KaÅŸar, Pizza Hamuru",
                        allergens: ["Gluten, SÃ¼t Ã¼rÃ¼nÃ¼"], // Varsa alerjenler
                        rating: 4.1, // ÃœrÃ¼n puanÄ±
                        lastUpdate: "BugÃ¼n"
                    },
                    {
                        name: "Ton BalÄ±klÄ± Pizza",
                        price: 265,
                        oldPrice: 250,
                        ingredients: "Ton BalÄ±ÄŸÄ±, KaÅŸar, MÄ±sÄ±r, Zeytin, Pizza Hamuru",
                        allergens: ["Gluten, SÃ¼t Ã¼rÃ¼nÃ¼"],
                        rating: 4.9,
                        lastUpdate: "3 hafta Ã¶nce"
                    },
                    {
                        name: "ÃœÃ§ Peynirli Pizza",
                        price: 220, // GÃ¼ncel fiyat
                        oldPrice: 220, // Eski fiyat (Zam okunu iÃ§in)
                        ingredients: "KaÅŸar, Mozarella, Tulum Peyniri, Pizza Hamuru",
                        allergens: ["Gluten, SÃ¼t Ã¼rÃ¼nÃ¼"], // Varsa alerjenler
                        rating: 5.0, // ÃœrÃ¼n puanÄ±
                        lastUpdate: "BugÃ¼n"
                    },
                    {
                        name: "Ã‡Ä±tÄ±r Tenders",
                        price: 185,
                        oldPrice: 165,
                        ingredients: "Tavuk, Galeta Unu, Yumurta, Baharat",
                        allergens: ["Gluten, Yumurta"],
                        rating: 4.9,
                        lastUpdate: "6 hafta Ã¶nce"
                    },
                    {
                        name: "Cajun Sepeti",
                        price: 185, // GÃ¼ncel fiyat
                        oldPrice: 185, // Eski fiyat (Zam okunu iÃ§in)
                        ingredients: "Tavuk, Galeta Unu, Yumurta, Baharat",
                        allergens: ["Gluten, Yumurta"], // Varsa alerjenler
                        rating: 3.9, // ÃœrÃ¼n puanÄ±
                        lastUpdate: "BugÃ¼n"
                    },
                    {
                        name: "Cajun DÃ¼rÃ¼m",
                        price: 155,
                        oldPrice: 155,
                        ingredients: "Tavuk, Galeta Unu, Yumurta, Baharat, LavaÅŸ",
                        allergens: ["Gluten, Yumurta"],
                        rating: 4.8,
                        lastUpdate: "DÃ¼n"
                    },
                    {
                        name: "KÃ¼lah Patso",
                        price: 95, // GÃ¼ncel fiyat
                        oldPrice: 90, // Eski fiyat (Zam okunu iÃ§in)
                        ingredients: "Patates",
                        allergens: [], // Varsa alerjenler
                        rating: 3.2, // ÃœrÃ¼n puanÄ±
                        lastUpdate: "BugÃ¼n"
                    },
                    {
                        name: "Crispy Chicken",
                        price: 180,
                        oldPrice: 180,
                        ingredients: "Tavuk, Galeta Unu, Yumurta, Baharat",
                        allergens: ["Gluten, Yumurta"],
                        rating: 4.4,
                        lastUpdate: "DÃ¼n"
                    },
                    {
                        name: "Tavuk Tako",
                        price: 210, // GÃ¼ncel fiyat
                        oldPrice: 195, // Eski fiyat (Zam okunu iÃ§in)
                        ingredients: "Tavuk, Patates, Ekmek",
                        allergens: ["Gluten"], // Varsa alerjenler
                        rating: 4.3, // ÃœrÃ¼n puanÄ±
                        lastUpdate: "5 gÃ¼n Ã¶nce"
                    },
                    {
                        name: "Penne Arabiata",
                        price: 165,
                        oldPrice: 165,
                        ingredients: "Makarna, Domates, SarÄ±msak, Peynir",
                        allergens: ["SÃ¼t Ã¼rÃ¼nÃ¼"],
                        rating: 4.6,
                        lastUpdate: "DÃ¼n"
                    },
                    {
                        name: "Kekikli Tavuk",
                        price: 185, // GÃ¼ncel fiyat
                        oldPrice: 185, // Eski fiyat (Zam okunu iÃ§in)
                        ingredients: "Kekik, Tavuk, Makarna, Salata",
                        allergens: [], // Varsa alerjenler
                        rating: 4.1, // ÃœrÃ¼n puanÄ±
                        lastUpdate: "BugÃ¼n"
                    },
                    {
                        name: "KÃ¶ri Soslu Tavuk",
                        price: 185,
                        oldPrice: 175,
                        ingredients: "KÃ¶ri BaharatÄ±, ZerdeÃ§al, SoÄŸan, SarÄ±msak, Tavuk",
                        allergens: ["SÃ¼t Ã¼rÃ¼nÃ¼"],
                        rating: 5.0,
                        lastUpdate: "DÃ¼n"
                    }
                    // Buraya daha fazla Ã¼rÃ¼n ekleyebilirsin...
                ]
            }
        ];
        // 3. FONKSÄ°YONLAR
        const panel = document.getElementById('infoPanel');
        const contentDiv = document.getElementById('panelContent');

        // Haritaya marker ekleme dÃ¶ngÃ¼sÃ¼
        venues.forEach(venue => {
            const marker = L.marker(venue.coords).addTo(map);

            // Marker'a tÄ±klandÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak olay
            marker.on('click', () => {
                openPanel(venue);
                // HaritayÄ± hafifÃ§e yukarÄ± kaydÄ±r ki marker panelin altÄ±nda kalmasÄ±n
                map.panTo([venue.coords[0] - 0.002, venue.coords[1]]);
            });
        });

        function openPanel(venue) {
            panel.style.transition = '';
            panel.style.transform = ''; // Varsa manuel kaydÄ±rmayÄ± da sÄ±fÄ±rla
            // 1. ÃœrÃ¼nlerin HTML iÃ§eriÄŸini oluÅŸtur
            let productsHtml = venue.products.map(prod => {
                // Fiyat deÄŸiÅŸim mantÄ±ÄŸÄ±
                let priceChangeHtml = '';
                if (prod.price > prod.oldPrice) {
                    priceChangeHtml = `<span class="price-change">â–² ${prod.oldPrice}â‚º'den yÃ¼kseldi (${prod.lastUpdate})</span>`;
                } else {
                    priceChangeHtml = `<span class="price-change price-stable">â— Fiyat sabit</span>`;
                }

                // Alerjen mantÄ±ÄŸÄ±
                let allergensHtml = prod.allergens.length > 0
                    ? `<div style="margin-top:5px;">${prod.allergens.map(a => `<span class="allergen-tag">âš ï¸ ${a}</span>`).join('')}</div>`
                    : '';

                return `
            <div class="menu-item">
                <div class="item-details">
                    <h4>${prod.name} <span style="font-size:0.8em; color:#f1c40f">â˜… ${prod.rating}</span></h4>
                    <p class="item-desc">${prod.ingredients}</p>
                    ${allergensHtml}
                </div>
                <div class="price-box">
                    <div class="current-price">${prod.price} â‚º</div>
                    ${priceChangeHtml}
                </div>
            </div>`;
            }).join('');

            // 2. Navigasyon Linki
            const navLink = `https://www.google.com/maps/dir/?api=1&destination=${venue.coords[0]},${venue.coords[1]}&travelmode=walking`;

            // 3. E-Posta Linki OluÅŸturma
            // Konu baÅŸlÄ±ÄŸÄ±na otomatik olarak Mekan AdÄ±nÄ± yazar.
            // %0D%0A kodu alt satÄ±ra geÃ§mek iÃ§indir.
            const mailSubject = `YETU Bildirim: ${venue.name}`;
            const mailBody = `Merhaba, ${venue.name} mekanÄ±nda ÅŸu bilgiyi gÃ¼ncellemek/eklemek istiyorum:%0D%0A%0D%0A(LÃ¼tfen buraya hatalÄ± fiyatÄ± veya yeni bilgiyi yazÄ±nÄ±z)`;
            const mailLink = `mailto:yetu.metu26@gmail.com?subject=${mailSubject}&body=${mailBody}`;

            // 4. Panelin Ana HTML'ini oluÅŸtur
            const html = `
            <div class="drag-handle-area">
            <div class="drag-handle-bar"></div>
            </div>
            <div class="venue-header">
                <h2 class="venue-name">${venue.name}</h2>
                <div class="rating-badge">${venue.rating} / 5.0 (${venue.reviews} yorum)</div>
            </div>

            <button class="nav-btn" onclick="window.open('${navLink}', '_blank')">
                ğŸ“ Yol Tarifi Al (Google Maps)
            </button>

            <h3>MenÃ¼ & Fiyatlar</h3>
            <div style="margin-top: 15px;">
                ${productsHtml}
            </div>

            <button class="report-btn" onclick="window.location.href='${mailLink}'">
                ğŸ“¢ Hata / Fiyat DeÄŸiÅŸimi Bildir
            </button>
        `;

            // 5. Ä°Ã§eriÄŸi panele bas ve paneli aÃ§
            contentDiv.innerHTML = html;
            panel.classList.add('active');
        }

        function closePanel() {
            panel.classList.remove('active');
        }

        // Haritada boÅŸ bir yere tÄ±klanÄ±nca paneli kapat
        map.on('click', closePanel);
        // --- KONUM BULMA Ã–ZELLÄ°ÄÄ° GÃœNCELLENMÄ°Å HALÄ° ---

        // DeÄŸiÅŸkenleri fonksiyonun dÄ±ÅŸÄ±nda tanÄ±mlÄ±yoruz ki her seferinde sÄ±fÄ±rlanmasÄ±n
        var userMarker = null;      // Mavi nokta
        var headingMarker = null;   // KÄ±rmÄ±zÄ± ok
        var accuracyCircle = null;  // Mavi geniÅŸ daire (Hata payÄ±)

        // watch: true -> Konumu sÃ¼rekli takip et demektir.
        // enableHighAccuracy: true -> Daha hassas (GPS) konum ister (ÅŸarjÄ± biraz daha yer ama yÃ¼rÃ¼rken gereklidir).
        map.locate({
            watch: true,
            enableHighAccuracy: true
        });

        // Ä°lk konumu alÄ±p almadÄ±ÄŸÄ±mÄ±zÄ± kontrol eden bir bayrak
        var isFirstLocation = true;

        // Marker deÄŸiÅŸkenleri (Daha Ã¶nce tanÄ±mlamÄ±ÅŸtÄ±k, tekrar hatÄ±rlatma)
        var userMarker = null;
        var headingMarker = null;
        var accuracyCircle = null;

        function onLocationFound(e) {
            var radius = e.accuracy;

            // --- 1. MarkerlarÄ± GÃ¼ncelleme KÄ±smÄ± (AynÄ± KalÄ±yor) ---

            // Mavi GeniÅŸ Daire
            if (accuracyCircle) {
                accuracyCircle.setLatLng(e.latlng);
                accuracyCircle.setRadius(radius);
            } else {
                accuracyCircle = L.circle(e.latlng, {
                    color: 'blue',
                    fillColor: '#3388ff',
                    fillOpacity: 0.15,
                    radius: radius
                }).addTo(map);
            }

            // Mavi Nokta
            if (userMarker) {
                userMarker.setLatLng(e.latlng);
            } else {
                var dotIcon = L.divIcon({
                    className: 'user-location-dot', // CSS sÄ±nÄ±fÄ±n
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                userMarker = L.marker(e.latlng, { icon: dotIcon }).addTo(map)
                    .bindPopup("Åu an buradasÄ±nÄ±z");
            }

            // KÄ±rmÄ±zÄ± Ok
            if (headingMarker) {
                headingMarker.setLatLng(e.latlng);
            } else {
                // Ok oluÅŸturma kodu (Ã–nceki cevaptaki HTML kodu buraya gelecek)
                var arrowIcon = L.divIcon({
                    className: 'user-heading-arrow',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20],
                    html: `<svg viewBox="0 0 24 24" width="40" height="40" style="transform: rotate(0deg); display:block;"><path fill="red" d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" /><path fill="none" stroke="white" stroke-width="2" d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" /></svg>`
                });
                headingMarker = L.marker(e.latlng, { icon: arrowIcon, zIndexOffset: 1000 }).addTo(map);
            }

            // --- 2. Kamera Odaklama MantÄ±ÄŸÄ± (YENÄ° KISIM) ---

            // EÄŸer bu aldÄ±ÄŸÄ±mÄ±z Ä°LK konum ise haritayÄ± oraya odakla
            if (isFirstLocation) {
                map.setView(e.latlng, 16); // 16 zoom seviyesine git
                isFirstLocation = false;   // ArtÄ±k ilk konum deÄŸil, bir daha odaklama yapma
            }
        }

        // 3. Konum bulunamazsa (izin verilmezse) hata verme
        function onLocationError(e) {
            alert("Konum izni vermediÄŸiniz iÃ§in yerinizi haritada gÃ¶steremiyoruz.");
            console.log("Konum alÄ±namadÄ±: " + e.message);
        }

        // OlaylarÄ± haritaya baÄŸla
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // --- KONUM BULMA Ã–ZELLÄ°ÄÄ° BÄ°TÄ°ÅÄ° ---

        // --- ARAMA ve FÄ°YAT KARÅILAÅTIRMA MANTIÄI ---

        const searchInput = document.getElementById('searchInput');

        // KullanÄ±cÄ± her harfe bastÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();

            // EÄŸer kutu boÅŸsa veya 2 harften azsa paneli kapat
            if (searchTerm.length < 2) {
                closePanel();
                return;
            }

            let results = [];

            // 1. TÃœM MEKANLARI TARA
            venues.forEach(venue => {
                venue.products.forEach(prod => {
                    // EÄŸer Ã¼rÃ¼n ismi aranan kelimeyi iÃ§eriyorsa
                    if (prod.name.toLowerCase().includes(searchTerm)) {
                        results.push({
                            product: prod,
                            venueName: venue.name,
                            venueCoords: venue.coords, // KoordinatÄ± buraya kaydettik
                            venueRating: venue.rating
                        });
                    }
                });
            });

            // 2. SONUÃ‡LARI FÄ°YATA GÃ–RE SIRALA (Ucuzdan PahalÄ±ya)
            results.sort((a, b) => a.product.price - b.product.price);

            // 3. SONUÃ‡LARI GÃ–STER
            if (results.length > 0) {
                displaySearchResults(results, searchTerm);
            } else {
                // SonuÃ§ yoksa paneli kapatabiliriz veya "SonuÃ§ yok" yazdÄ±rabiliriz
                closePanel();
            }
        });

        function displaySearchResults(results, term) {
            let htmlContent = `
                <div class="venue-header">
                    <h2 class="venue-name">"${term}" iÃ§in SonuÃ§lar</h2>
                    <div class="rating-badge">${results.length} Ã¼rÃ¼n bulundu</div>
                </div>
                <div style="margin-top: 15px;">
            `;

            results.forEach(item => {
                // DÃœZELTÄ°LEN KISIM BURASI:
                // 1. "venue" yerine "item.venueCoords" kullandÄ±k.
                // 2. Link yapÄ±sÄ±nÄ± dÃ¼zelttik.
                const navLink = `https://www.google.com/maps?q=${item.venueCoords[0]},${item.venueCoords[1]}&mode=walking`;

                htmlContent += `
                <div class="menu-item" style="border-left: 5px solid #27ae60;">
                    <div class="item-details">
                        <span class="venue-tag">ğŸ“ ${item.venueName} (${item.venueRating} puan)</span>
                        <h4>${item.product.name}</h4>
                        <p class="item-desc">${item.product.ingredients}</p>
                        
                        <button style="margin-top:5px; background:#3498db; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem;" 
                                onclick="window.open('${navLink}', '_blank')">
                            Yol Tarifi â†—
                        </button>
                    </div>
                    <div class="price-box">
                        <div class="current-price" style="font-size: 1.2rem; color:#e74c3c;">${item.product.price} â‚º</div>
                    </div>
                </div>`;
            });

            htmlContent += `</div>`;

            contentDiv.innerHTML = htmlContent;
            panel.classList.add('active');
        }
        // --- AÅAÄI KAYDIRARAK KAPATMA MANTIÄI (GÃœNCELLENMÄ°Å) ---

        // 1. Sadece tutacaÄŸÄ± (handle) seÃ§iyoruz
        const dragHandle = document.querySelector('.sheet-handle');
        // Not: 'panel' deÄŸiÅŸkeni zaten yukarÄ±da tanÄ±mlÄ±ydÄ±, aynen kullanÄ±yoruz.

        let startY = 0;
        let currentY = 0;
        let isDragging = false;

        // OlaylarÄ± 'dragHandle'a ekliyoruz
        dragHandle.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            isDragging = true;
            panel.style.transition = 'none'; // SÃ¼rÃ¼klerken gecikme olmasÄ±n
        }, { passive: false }); // passive: false yaptÄ±k ki gerekirse mÃ¼dahale edelim

        dragHandle.addEventListener('touchmove', (e) => {
            if (!isDragging) return;

            // VarsayÄ±lan kaydÄ±rmayÄ± engelle (Sayfa oynamasÄ±n, sadece panel oynasÄ±n)
            e.preventDefault();

            currentY = e.touches[0].clientY;
            const diff = currentY - startY;

            // Sadece aÅŸaÄŸÄ± doÄŸru Ã§ekiliyorsa
            if (diff > 0) {
                panel.style.transform = `translateY(${diff}px)`;
            }
        }, { passive: false });

        dragHandle.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;

            const diff = currentY - startY;

            // EÄŸer 100px'den fazla aÅŸaÄŸÄ± Ã§ekildiyse kapat
            if (diff > 100) {
                // 1. Ã–nce paneli animasyonla aÅŸaÄŸÄ± kaydÄ±r (GÃ¶rsel olarak kapat)
                panel.style.transition = 'transform 0.3s ease-out';
                panel.style.transform = 'translateY(100%)';

                // 2. Animasyon sÃ¼resi (300ms) dolunca arka planda sÄ±fÄ±rlama yap
                setTimeout(() => {
                    // "active" sÄ±nÄ±fÄ±nÄ± kaldÄ±r (CSS ile bottom: -100% durumuna geÃ§er)
                    closePanel();
                    panel.style.transition = 'none';
                    panel.style.transform = '';

                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            panel.style.transition = '';
                        }, 50);
                    });

                }, 300); // Bu sÃ¼re (300ms) yukarÄ±daki CSS transition sÃ¼resiyle aynÄ± olmalÄ±
            } else {
                // Yeterince Ã§ekilmediyse yerine geri zÄ±plasÄ±n
                panel.style.transition = 'transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1)';
                panel.style.transform = 'translateY(0)';
            }
        });
    </script>
</body>
</html>