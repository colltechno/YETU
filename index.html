<!DOCTYPE html>
<html lang="tr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DEK277J82C"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-DEK277J82C');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YETU - ODTÃœ KampÃ¼s Rehberi</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }

        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Harita Konteyneri */
        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Alt Panel (Bottom Sheet) Stilleri */
        .bottom-sheet {
            position: fixed;
            bottom: -100%; /* BaÅŸlangÄ±Ã§ta ekran dÄ±ÅŸÄ±nda */
            left: 0;
            width: 100%;
            height: 70vh; /* EkranÄ±n %70'ini kaplar */
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            transition: bottom 0.4s cubic-bezier(0.1, 0.7, 0.1, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

            .bottom-sheet.active {
                bottom: 0;
            }

        /* Panel TutacaÄŸÄ± (SÃ¼rÃ¼kleme hissi iÃ§in) */
        .sheet-handle {
            width: 50px;
            height: 5px;
            background-color: #ddd;
            border-radius: 5px;
            margin: 15px auto;
            flex-shrink: 0;
            position: relative; /* GÃ¶rÃ¼nmez alanÄ± buna hizalamak iÃ§in gerekli */
            touch-action: none; /* TarayÄ±cÄ±nÄ±n kendi kaydÄ±rmasÄ±nÄ± iptal eder */
            cursor: grab;
        }

            /* 2. Ã‡ubuÄŸun EtrafÄ±ndaki GÃ¶rÃ¼nmez Dokunma AlanÄ± (::after) */
            .sheet-handle::after {
                content: "";
                position: absolute;
                /* Ã‡ubuÄŸun her yÃ¶nÃ¼nden 25px dÄ±ÅŸarÄ± taÅŸan gÃ¶rÃ¼nmez bir kutu yaratÄ±yoruz */
                top: -25px;
                bottom: -25px;
                left: -25px;
                right: -25px;
                /* Test etmek iÃ§in aÅŸaÄŸÄ±daki satÄ±rÄ± aÃ§Ä±p kÄ±rmÄ±zÄ± kutuyu gÃ¶rebilirsin: */
                /* background-color: rgba(255, 0, 0, 0.3); */
            }

        /* Ä°Ã§erik AlanÄ± */
        .sheet-content {
            padding: 0 20px 20px 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            border: none;
            background: #f0f0f0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
        }

        /* Mekan Detay Stilleri */
        .venue-header {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .venue-name {
            font-size: 1.5rem;
            color: #333;
        }

        .rating-badge {
            display: inline-block;
            background-color: #27ae60;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* MenÃ¼ KartlarÄ± */
        .menu-item {
            display: flex;
            justify-content: space-between;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            background: #fff;
        }

        .item-details h4 {
            margin-bottom: 4px;
            color: #333;
        }

        .item-desc {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }

        .allergen-tag {
            font-size: 0.7rem;
            background: #fff3cd;
            color: #856404;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
        }

        .price-box {
            text-align: right;
            min-width: 80px;
        }

        .current-price {
            font-weight: bold;
            color: #2c3e50;
        }

        .price-change {
            font-size: 0.7rem;
            color: #e74c3c;
            display: block;
            margin-top: 2px;
        }

        .price-stable {
            color: #27ae60;
        }
        /* YÃ¶n Okunun Stili */
        .user-heading-arrow {
            z-index: 1000;
        }
        .user-heading-arrow svg {
                transition: transform 0.2s linear;
        }
        /* Navigasyon Butonu Stili */
        .nav-btn {
            background-color: #2980b9; /* Mavi renk */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px; /* Ä°kon ile yazÄ± arasÄ± boÅŸluk */
        }

            .nav-btn:hover {
                background-color: #1f618d;
            }
        /* Bildirim Butonu Stili */
        .report-btn {
            background-color: #f39c12; /* Turuncu renk */
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

            .report-btn:hover {
                background-color: #d35400;
            }
        /* --- ARAMA Ã‡UBUÄU STÄ°LLERÄ° --- */
        .search-container {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 160px);
            max-width: 400px;
            background: white;
            border-radius: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            padding: 5px 5px 5px 20px;
            z-index: 2000;
        }
        .search-input {
            border: none;
            outline: none;
            flex-grow: 1;
            font-size: 1rem;
            color: #333;
            padding: 10px 0;
            background: transparent;
        }
        /* Arama sonuÃ§larÄ± iÃ§in Ã¶zel etiket */
        .venue-tag {
            font-size: 0.75rem;
            color: #7f8c8d;
            display: block;
            margin-bottom: 2px;
        }
        .user-location-dot {
            background-color: #007bff;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            width: 16px;
            height: 16px;
        }
        /* --- GÄ°RÄ°Å & PROFÄ°L STÄ°LLERÄ° --- */

        /* SaÄŸ Ãœstteki Yuvarlak Profil Butonu */
        .profile-btn-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 2001;
        }

        /* Profil butonu ana Ã§erÃ§evesi */
        .profile-btn {
            width: 45px;
            height: 45px;
            background: white;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            padding: 0;
            overflow: hidden; 
        }
        .profile-btn-img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            border-radius: 50%;
        }

            .profile-btn:active {
                transform: scale(0.95);
            }

        /* GiriÅŸ Formu TasarÄ±mÄ± (Panel Ä°Ã§i) */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .auth-input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: #f9f9f9;
        }

        .auth-btn {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }

        .btn-primary {
            background-color: #e74c3c;
        }
        /* KÄ±rmÄ±zÄ± */
        .btn-secondary {
            background-color: #34495e;
            margin-top: 10px;
        }
        /* Gri */

        .auth-toggle-text {
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            cursor: pointer;
            text-decoration: underline;
        }
        .add-venue-btn {
            position: absolute;
            bottom: 30px; /* Alttan mesafe */
            left: 20px; /* Soldan mesafe */
            width: 50px;
            height: 50px;
            background-color: #e67e22; /* Turuncu renk */
            color: white;
            border-radius: 50%;
            border: none;
            font-size: 2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000; /* HaritanÄ±n Ã¼stÃ¼nde dursun */
            display: none; /* BaÅŸlangÄ±Ã§ta gizli (Sadece admin gÃ¶recek) */
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

            .add-venue-btn:active {
                transform: scale(0.9);
            }
        /* --- ADMÄ°N DÃœZENLEME FORMU STÄ°LLERÄ° --- */
        .edit-item-box {
            background: #f9f9f9;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: relative; /* Silme butonu iÃ§in */
        }

        .edit-label {
            font-size: 0.75rem;
            color: #7f8c8d;
            font-weight: bold;
            margin-bottom: 2px;
            display: block;
        }

        .edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9rem;
            box-sizing: border-box; /* TaÅŸmayÄ± engeller */
        }

        .delete-product-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            align-self: flex-end; /* SaÄŸa yasla */
        }
    </style>
</head>
<body>

    <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="YETU ile istediÄŸini bul!">
    </div>

    <div id="map"></div>

    <button id="addVenueBtn" class="add-venue-btn" onclick="openAddVenuePanel()">
        +
    </button>

    <div class="profile-btn-container">
        <button id="mainProfileBtn" class="profile-btn" onclick="openAuthPanel()">
            <img src="logo.png" alt="Profil" class="profile-btn-img">
        </button>
    </div>

    <div class="bottom-sheet" id="infoPanel">
        <div class="sheet-handle"></div>
        <button class="close-btn" onclick="closePanel()">âœ•</button>

        <div class="sheet-content" id="panelContent">
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. HARÄ°TA AYARLARI
        // ODTÃœ kampÃ¼s koordinatlarÄ±na (yaklaÅŸÄ±k kÃ¼tÃ¼phane/Ã§arÅŸÄ± civarÄ±) odaklanÄ±yoruz
        const map = L.map('map').setView([39.8917541320506, 32.78581820941704], 16);

        // OpenStreetMap katmanÄ±nÄ± ekle
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // 3. FONKSÄ°YONLAR
        const panel = document.getElementById('infoPanel');
        const contentDiv = document.getElementById('panelContent');

        // Haritaya marker ekleme dÃ¶ngÃ¼sÃ¼


        function openPanel(venue) {
            panel.style.transition = '';
            panel.style.transform = ''; // Varsa manuel kaydÄ±rmayÄ± da sÄ±fÄ±rla

            // --- ADMIN KONTROLÃœ (YENÄ°) ---
            let adminButtonHtml = '';
            // window.isAdmin fonksiyonu var mÄ± ve true dÃ¶nÃ¼yor mu?
            if (window.isAdmin && window.isAdmin()) {
                adminButtonHtml = `
                        <button onclick="window.enableEditMode('${venue.firebaseId}')"
                                style="background:#34495e; color:white; border:none; padding:5px 10px; border-radius:5px; margin-bottom:10px; cursor:pointer; font-size:0.8rem; width:100%;">
                            âœï¸ MenÃ¼yÃ¼ DÃ¼zenle (Admin)
                        </button>
                    `;
            }
            // 1. ÃœrÃ¼nlerin HTML iÃ§eriÄŸini oluÅŸtur
            let productsHtml = venue.products.map(prod => {
                // Fiyat deÄŸiÅŸim mantÄ±ÄŸÄ±
                let priceChangeHtml = '';
                if (prod.price > prod.oldPrice) {
                    priceChangeHtml = `<span class="price-change">â–² ${prod.oldPrice}â‚º'den yÃ¼kseldi (${prod.lastUpdate})</span>`;
                } else {
                    priceChangeHtml = `<span class="price-change price-stable">â— Fiyat sabit</span>`;
                }

                // Alerjen mantÄ±ÄŸÄ±
                let allergensHtml = prod.allergens.length > 0
                    ? `<div style="margin-top:5px;">${prod.allergens.map(a => `<span class="allergen-tag">âš ï¸ ${a}</span>`).join('')}</div>`
                    : '';

                return `
                    <div class="menu-item">
                        <div class="item-details">
                            <h4>${prod.name} <span style="font-size:0.8em; color:#f1c40f">â˜… ${prod.rating}</span></h4>
                            <p class="item-desc">${prod.ingredients}</p>
                            ${allergensHtml}
                        </div>
                        <div class="price-box">
                            <div class="current-price">${prod.price} â‚º</div>
                            ${priceChangeHtml}
                        </div>
                    </div>`;
            }).join('');

            // 2. Navigasyon Linki
            const navLink = `https://www.google.com/maps/dir/?api=1&destination=${venue.coords[0]},${venue.coords[1]}&travelmode=walking`;

            // 3. E-Posta Linki OluÅŸturma
            // Konu baÅŸlÄ±ÄŸÄ±na otomatik olarak Mekan AdÄ±nÄ± yazar.
            // %0D%0A kodu alt satÄ±ra geÃ§mek iÃ§indir.
            const mailSubject = `YETU Bildirim: ${venue.name}`;
            const mailBody = `Merhaba, ${venue.name} mekanÄ±nda ÅŸu bilgiyi gÃ¼ncellemek/eklemek istiyorum:%0D%0A%0D%0A(LÃ¼tfen buraya hatalÄ± fiyatÄ± veya yeni bilgiyi yazÄ±nÄ±z)`;
            const mailLink = `mailto:yetu.metu26@gmail.com?subject=${mailSubject}&body=${mailBody}`;

            // HTML Åablonu
            const html = `
                    <div class="drag-handle-area">
                        <div class="drag-handle-bar"></div>
                    </div>

                    <div class="venue-header">
                        <h2 class="venue-name">${venue.name}</h2>
                        <div class="rating-badge">${venue.rating} / 5.0 (${venue.reviews} yorum)</div>
                    </div>

                    ${adminButtonHtml}

                    <button class="nav-btn" onclick="window.open('${navLink}', '_blank')">
                        ğŸ“ Yol Tarifi Al (Google Maps)
                    </button>

                    <h3>MenÃ¼ & Fiyatlar</h3>

                    <div id="productsContainer" style="margin-top: 15px;">
                        ${productsHtml}
                    </div>

                    <button class="report-btn" onclick="window.location.href='${mailLink}'">
                        ğŸ“¢ Hata / Fiyat DeÄŸiÅŸimi Bildir
                    </button>
                `;

            contentDiv.innerHTML = html;
            panel.classList.add('active');
        }

        function closePanel() {
            panel.classList.remove('active');
        }

        // Haritada boÅŸ bir yere tÄ±klanÄ±nca paneli kapat
        map.on('click', closePanel);
        // --- KONUM BULMA ve YÃ–N Ã–ZELLÄ°ÄÄ° (GÃœNCELLENMÄ°Å HÄ°BRÄ°T SÄ°STEM) ---

        // DeÄŸiÅŸkenler
        var userMarker = null;      // Mavi nokta
        var headingMarker = null;   // KÄ±rmÄ±zÄ± ok
        var accuracyCircle = null;  // Hata payÄ± dairesi
        var isFirstLocation = true; // Ä°lk aÃ§Ä±lÄ±ÅŸ kontrolÃ¼
        var useGPSHeading = false;  // YÃ¼rÃ¼yor mu kontrolÃ¼ (GPS vs Pusula)

        // 1. Konum takibini baÅŸlat (SÃ¼rekli izleme + YÃ¼ksek hassasiyet)
        map.locate({
            watch: true,
            enableHighAccuracy: true
        });

        // 2. Oku dÃ¶ndÃ¼ren yardÄ±mcÄ± fonksiyon
        var currentVisualHeading = 0;

        function rotateArrow(newHeading) {
            if (!headingMarker) return;

            var iconElement = headingMarker.getElement();
            if (iconElement) {
                var svg = iconElement.querySelector('svg');
                if (svg) {
                    // 1. Yeni gelen aÃ§Ä± ile ÅŸu anki gÃ¶rsel aÃ§Ä± arasÄ±ndaki farkÄ± bul
                    var diff = newHeading - (currentVisualHeading % 360);

                    // 2. FarkÄ± -180 ile +180 arasÄ±na sÄ±kÄ±ÅŸtÄ±r (En kÄ±sa yolu bul)
                    if (diff > 180) {
                        diff -= 360; // 350 yerine -10 yap
                    } else if (diff < -180) {
                        diff += 360; // -350 yerine +10 yap
                    }

                    // 3. GÃ¶rsel aÃ§Ä±yÄ± gÃ¼ncelle (KÃ¼mÃ¼latif olarak artÄ±r/azalt)
                    currentVisualHeading += diff;

                    // 4. CSS'e yeni deÄŸeri uygula
                    svg.style.transform = `rotate(${currentVisualHeading}deg)`;
                }
            }
        }

        // 3. Konum bulunduÄŸunda Ã§alÄ±ÅŸacak ana fonksiyon
        function onLocationFound(e) {
            var radius = e.accuracy;

            // --- A) MarkerlarÄ± OluÅŸtur/GÃ¼ncelle ---

            // Mavi Daire (Hata PayÄ±)
            if (accuracyCircle) {
                accuracyCircle.setLatLng(e.latlng);
                accuracyCircle.setRadius(radius);
            } else {
                accuracyCircle = L.circle(e.latlng, { color: 'blue', fillColor: '#3388ff', fillOpacity: 0.15, radius: radius }).addTo(map);
            }

            // Mavi Nokta (KullanÄ±cÄ±)
            if (userMarker) {
                userMarker.setLatLng(e.latlng);
            } else {
                var dotIcon = L.divIcon({ className: 'user-location-dot', iconSize: [16, 16], iconAnchor: [8, 8] });
                userMarker = L.marker(e.latlng, { icon: dotIcon }).addTo(map).bindPopup("Åu an buradasÄ±nÄ±z");
            }

            // KÄ±rmÄ±zÄ± Ok (YÃ¶n)
            if (headingMarker) {
                headingMarker.setLatLng(e.latlng);
            } else {
                var arrowIcon = L.divIcon({
                    className: 'user-heading-arrow',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20],
                    html: `<svg viewBox="0 0 24 24" width="40" height="40" style="transform: rotate(0deg); display:block;"><path fill="red" d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" /><path fill="none" stroke="white" stroke-width="2" d="M12 2L4.5 20.29L5.21 21L12 18L18.79 21L19.5 20.29L12 2Z" /></svg>`
                });
                headingMarker = L.marker(e.latlng, { icon: arrowIcon, zIndexOffset: 1000 }).addTo(map);
            }

            // --- B) Kamera Odaklama (Sadece ilk aÃ§Ä±lÄ±ÅŸta) ---
            if (isFirstLocation) {
                map.setView(e.latlng, 16);
                isFirstLocation = false;
            }

            // --- C) AkÄ±llÄ± YÃ¶n AlgÄ±lama (GPS vs Pusula) ---
            // HÄ±z 1 m/s'den (yaklaÅŸÄ±k 3.6 km/s) bÃ¼yÃ¼kse yÃ¼rÃ¼yordur.
            if (e.speed && e.speed > 1 && e.heading !== null && !isNaN(e.heading)) {
                useGPSHeading = true; // YÃ¼rÃ¼yor: PusulayÄ± sustur, GPS'i dinle.
                rotateArrow(e.heading);
            } else {
                useGPSHeading = false; // Duruyor: Pusulaya geri dÃ¶n.
            }
        }

        // 4. Pusula SensÃ¶rÃ¼ Dinleyicisi
        if (window.DeviceOrientationEvent) {
            // Android Absolute Fix
            var eventName = 'ondeviceorientationabsolute' in window ? 'deviceorientationabsolute' : 'deviceorientation';

            window.addEventListener(eventName, function (event) {
                // EÄŸer kullanÄ±cÄ± yÃ¼rÃ¼yorsa (GPS aktifse) bu fonksiyonu hemen durdur.
                if (useGPSHeading) return;

                // Marker yoksa iÅŸlem yapma
                if (!headingMarker) return;

                var heading = null;

                if (event.webkitCompassHeading) {
                    heading = event.webkitCompassHeading; // iOS
                } else if (event.absolute && event.alpha) {
                    heading = 360 - event.alpha; // Android Absolute
                } else if (event.alpha) {
                    heading = 360 - event.alpha; // Android Standart
                }

                if (heading !== null) {
                    rotateArrow(heading);
                }
            }, true);
        }

        function onLocationError(e) {
            console.log("Konum hatasÄ±: " + e.message);
            // Hata olursa kullanÄ±cÄ±yÄ± rahatsÄ±z etmemek iÃ§in alert vermiyoruz, konsola yazÄ±yoruz.
        }

        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // --- KONUM BULMA Ã–ZELLÄ°ÄÄ° BÄ°TÄ°ÅÄ° ---

        // --- ARAMA ve FÄ°YAT KARÅILAÅTIRMA MANTIÄI ---

        const searchInput = document.getElementById('searchInput');

        // KullanÄ±cÄ± her harfe bastÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±r
        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();

            // EÄŸer kutu boÅŸsa veya 2 harften azsa paneli kapat
            if (searchTerm.length < 2) {
                closePanel();
                return;
            }

            let results = [];

            // 1. TÃœM MEKANLARI TARA
            window.venues.forEach(venue => {
                venue.products.forEach(prod => {
                    // EÄŸer Ã¼rÃ¼n ismi aranan kelimeyi iÃ§eriyorsa
                    if (prod.name.toLowerCase().includes(searchTerm)) {
                        results.push({
                            product: prod,
                            venueName: venue.name,
                            venueCoords: venue.coords, // KoordinatÄ± buraya kaydettik
                            venueRating: venue.rating
                        });
                    }
                });
            });

            // 2. SONUÃ‡LARI FÄ°YATA GÃ–RE SIRALA (Ucuzdan PahalÄ±ya)
            results.sort((a, b) => a.product.price - b.product.price);

            // 3. SONUÃ‡LARI GÃ–STER
            if (results.length > 0) {
                displaySearchResults(results, searchTerm);
            } else {
                // SonuÃ§ yoksa paneli kapatabiliriz veya "SonuÃ§ yok" yazdÄ±rabiliriz
                closePanel();
            }
        });

        function displaySearchResults(results, term) {
            let htmlContent = `
                        <div class="venue-header">
                            <h2 class="venue-name">"${term}" iÃ§in SonuÃ§lar</h2>
                            <div class="rating-badge">${results.length} Ã¼rÃ¼n bulundu</div>
                        </div>
                        <div style="margin-top: 15px;">
                    `;

            results.forEach(item => {
                // DÃœZELTÄ°LEN KISIM BURASI:
                // 1. "venue" yerine "item.venueCoords" kullandÄ±k.
                // 2. Link yapÄ±sÄ±nÄ± dÃ¼zelttik.
                const navLink = `https://www.google.com/maps?q=${item.venueCoords[0]},${item.venueCoords[1]}&mode=walking`;

                htmlContent += `
                        <div class="menu-item" style="border-left: 5px solid #27ae60;">
                            <div class="item-details">
                                <span class="venue-tag">ğŸ“ ${item.venueName} (${item.venueRating} puan)</span>
                                <h4>${item.product.name}</h4>
                                <p class="item-desc">${item.product.ingredients}</p>

                                <button style="margin-top:5px; background:#3498db; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem;"
                                        onclick="window.open('${navLink}', '_blank')">
                                    Yol Tarifi â†—
                                </button>
                            </div>
                            <div class="price-box">
                                <div class="current-price" style="font-size: 1.2rem; color:#e74c3c;">${item.product.price} â‚º</div>
                            </div>
                        </div>`;
            });

            htmlContent += `</div>`;

            contentDiv.innerHTML = htmlContent;
            panel.classList.add('active');
        }
        // --- AÅAÄI KAYDIRARAK KAPATMA MANTIÄI (GÃœNCELLENMÄ°Å) ---

        // 1. Sadece tutacaÄŸÄ± (handle) seÃ§iyoruz
        const dragHandle = document.querySelector('.sheet-handle');
        // Not: 'panel' deÄŸiÅŸkeni zaten yukarÄ±da tanÄ±mlÄ±ydÄ±, aynen kullanÄ±yoruz.

        let startY = 0;
        let currentY = 0;
        let isDragging = false;

        // OlaylarÄ± 'dragHandle'a ekliyoruz
        dragHandle.addEventListener('touchstart', (e) => {
            startY = e.touches[0].clientY;
            isDragging = true;
            panel.style.transition = 'none'; // SÃ¼rÃ¼klerken gecikme olmasÄ±n
        }, { passive: false }); // passive: false yaptÄ±k ki gerekirse mÃ¼dahale edelim

        dragHandle.addEventListener('touchmove', (e) => {
            if (!isDragging) return;

            // VarsayÄ±lan kaydÄ±rmayÄ± engelle (Sayfa oynamasÄ±n, sadece panel oynasÄ±n)
            e.preventDefault();

            currentY = e.touches[0].clientY;
            const diff = currentY - startY;

            // Sadece aÅŸaÄŸÄ± doÄŸru Ã§ekiliyorsa
            if (diff > 0) {
                panel.style.transform = `translateY(${diff}px)`;
            }
        }, { passive: false });

        dragHandle.addEventListener('touchend', (e) => {
            if (!isDragging) return;
            isDragging = false;

            const diff = currentY - startY;

            // EÄŸer 100px'den fazla aÅŸaÄŸÄ± Ã§ekildiyse kapat
            if (diff > 100) {
                // 1. Ã–nce paneli animasyonla aÅŸaÄŸÄ± kaydÄ±r (GÃ¶rsel olarak kapat)
                panel.style.transition = 'transform 0.3s ease-out';
                panel.style.transform = 'translateY(100%)';

                // 2. Animasyon sÃ¼resi (300ms) dolunca arka planda sÄ±fÄ±rlama yap
                setTimeout(() => {
                    // "active" sÄ±nÄ±fÄ±nÄ± kaldÄ±r (CSS ile bottom: -100% durumuna geÃ§er)
                    closePanel();
                    panel.style.transition = 'none';
                    panel.style.transform = '';

                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            panel.style.transition = '';
                        }, 50);
                    });

                }, 300); // Bu sÃ¼re (300ms) yukarÄ±daki CSS transition sÃ¼resiyle aynÄ± olmalÄ±
            } else {
                // Yeterince Ã§ekilmediyse yerine geri zÄ±plasÄ±n
                panel.style.transition = 'transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1)';
                panel.style.transform = 'translateY(0)';
            }
        });
        // --- GÄ°RÄ°Å PANELÄ°NÄ° AÃ‡MA FONKSÄ°YONU ---
        function openAuthPanel() {
            const contentDiv = document.getElementById('panelContent');
            const panel = document.getElementById('infoPanel');

            // EÄŸer kullanÄ±cÄ± zaten giriÅŸ yapmÄ±ÅŸsa (Bunu global deÄŸiÅŸkenden anlayacaÄŸÄ±z)
            if (window.currentUserEmail) {
                // --- PROFÄ°L GÃ–RÃœNÃœMÃœ ---
                contentDiv.innerHTML = `
                <div class="venue-header">
                    <h2 class="venue-name">Profilim</h2>
                </div>
                <div style="text-align:center; margin-top:20px;">
                    <div style="font-size: 3rem;">ğŸ‘‹</div>
                    <h3>Merhaba!</h3>
                    <p style="color:#666; margin-bottom:20px;">${window.currentUserEmail}</p>

                    <button class="auth-btn btn-primary" onclick="window.cikisYap(); closePanel();">
                        Ã‡Ä±kÄ±ÅŸ Yap
                    </button>
                </div>
            `;
            } else {
                // --- GÄ°RÄ°Å / KAYIT GÃ–RÃœNÃœMÃœ ---
                // VarsayÄ±lan olarak GiriÅŸ Formu gelsin
                showLoginForm();
            }

            panel.classList.add('active');
        }

        // GiriÅŸ Formunu HTML olarak Ã§izen fonksiyon
        function showLoginForm() {
            const contentDiv = document.getElementById('panelContent');
            contentDiv.innerHTML = `
            <div class="venue-header">
                <h2 class="venue-name">GiriÅŸ Yap</h2>
                <p>Favorilerinizi kaydetmek iÃ§in giriÅŸ yapÄ±n.</p>
            </div>
            <div class="auth-form">
                <input type="email" id="emailInput" class="auth-input" placeholder="E-posta Adresi">
                <input type="password" id="passInput" class="auth-input" placeholder="Åifre">

                <button class="auth-btn btn-primary" onclick="handleLogin()">GiriÅŸ Yap</button>

                <p class="auth-toggle-text" onclick="showRegisterForm()">
                    HesabÄ±n yok mu? <strong>KayÄ±t Ol</strong>
                </p>
            </div>
        `;
        }

        // KayÄ±t Formunu HTML olarak Ã§izen fonksiyon
        function showRegisterForm() {
            const contentDiv = document.getElementById('panelContent');
            contentDiv.innerHTML = `
            <div class="venue-header">
                <h2 class="venue-name">KayÄ±t Ol</h2>
                <p>Yeni bir hesap oluÅŸtur.</p>
            </div>
            <div class="auth-form">
                <input type="email" id="emailInput" class="auth-input" placeholder="E-posta Adresi">
                <input type="password" id="passInput" class="auth-input" placeholder="Åifre (En az 6 karakter)">

                <button class="auth-btn btn-secondary" onclick="handleRegister()">KayÄ±t Ol</button>

                <p class="auth-toggle-text" onclick="showLoginForm()">
                    Zaten hesabÄ±n var mÄ±? <strong>GiriÅŸ Yap</strong>
                </p>
            </div>
        `;
        }

        // Butonlara basÄ±lÄ±nca Ã§alÄ±ÅŸacak ara fonksiyonlar
        function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passInput').value;
            window.girisYap(email, pass); // Firebase fonksiyonunu Ã§aÄŸÄ±r
        }

        function handleRegister() {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passInput').value;
            window.kayitOl(email, pass); // Firebase fonksiyonunu Ã§aÄŸÄ±r
        }
    </script>
    <script type="module">
        // 1. Gerekli kÃ¼tÃ¼phaneleri iÃ§eri aktarÄ±yoruz
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // 2. Senin Firebase AyarlarÄ±n
        const firebaseConfig = {
            apiKey: "AIzaSyDTlQLuyN7DvEdvmPQmwBr3u2I7XVAOfbM",
            authDomain: "yetu-app-ba044.firebaseapp.com",
            projectId: "yetu-app-ba044",
            storageBucket: "yetu-app-ba044.firebasestorage.app",
            messagingSenderId: "490891866396",
            appId: "1:490891866396:web:2d93af24e5eccfc93d8ad9",
            measurementId: "G-BK3GHNQEMB"
        };

        // 3. Firebase'i BaÅŸlat
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL FONKSÄ°YONLAR (Butonlar iÃ§in) ---
        window.kayitOl = async (email, sifre) => {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, sifre);
                alert("KayÄ±t baÅŸarÄ±lÄ±! HoÅŸgeldin: " + userCredential.user.email);
            } catch (error) {
                alert("Hata: " + error.message);
            }
        };

        window.girisYap = async (email, sifre) => {
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, sifre);
                alert("GiriÅŸ yapÄ±ldÄ±: " + userCredential.user.email);
            } catch (error) {
                alert("GiriÅŸ HatasÄ±: " + error.message);
            }
        };

        window.cikisYap = async () => {
            try {
                await signOut(auth);
                alert("Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.");
            } catch (error) {
                console.error(error);
            }
        };

        // --- YENÄ° MEKAN EKLEME SÄ°STEMÄ° ---
        let selectedCoords = null;

        window.openAddVenuePanel = () => {
            const panel = document.getElementById('infoPanel');
            const contentDiv = document.getElementById('panelContent');

            contentDiv.innerHTML = `
                <div class="venue-header">
                    <h2 class="venue-name">âœ¨ Yeni Mekan Ekle</h2>
                </div>
                <div class="auth-form">
                    <label>Mekan AdÄ±:</label>
                    <input type="text" id="newVenueName" class="auth-input" placeholder="Ã–rn: Ã‡atÄ± Kafe">

                    <label>Koordinat (Enlem, Boylam):</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="newVenueCoords" class="auth-input" placeholder="39.9012, 32.8055" >
                        <button onclick="pickLocationOnMap()" style="background:#3498db; color:white; border:none; border-radius:5px; padding:0 10px; cursor:pointer; white-space:nowrap;">
                            ğŸ“ Haritadan
                        </button>
                    </div>

                    <p style="font-size:0.8rem; color:#666; margin-top:5px;">
                        Google Maps'ten saÄŸ tÄ±kla kopyaladÄ±ÄŸÄ±nÄ±z koordinatÄ± buraya yapÄ±ÅŸtÄ±rabilirsiniz.
                    </p>

                    <button onclick="saveNewVenue()" class="auth-btn btn-primary" style="margin-top:15px;">
                        âœ… MEKANI OLUÅTUR
                    </button>
                </div>
            `;
            panel.classList.add('active');
        };

        window.pickLocationOnMap = () => {
            alert("LÃ¼tfen harita Ã¼zerinde mekanÄ±n olduÄŸu yere tÄ±klayÄ±n.");
            const panel = document.getElementById('infoPanel');
            panel.classList.remove('active');

            map.once('click', function (e) {
                selectedCoords = [e.latlng.lat, e.latlng.lng];
                window.openAddVenuePanel();
                setTimeout(() => {
                    const nameInput = document.getElementById('newVenueName');
                    const coordInput = document.getElementById('newVenueCoords');
                    coordInput.value = selectedCoords[0].toFixed(5) + ", " + selectedCoords[1].toFixed(5);
                }, 100);
            });
        };

        window.saveNewVenue = async () => {
            const name = document.getElementById('newVenueName').value;
            const coordsInput = document.getElementById('newVenueCoords').value;

            if (!name || !coordsInput) {
                alert("LÃ¼tfen isim ve koordinat bilgilerini girin!");
                return;
            }

            let finalCoords = null;
            try {
                const parts = coordsInput.split(',');
                if (parts.length === 2) {
                    const lat = parseFloat(parts[0].trim());
                    const lng = parseFloat(parts[1].trim());
                    if (!isNaN(lat) && !isNaN(lng)) finalCoords = [lat, lng];
                }
            } catch (e) { console.error(e); }

            if (!finalCoords) {
                alert("Koordinat formatÄ± hatalÄ±! Ã–rnek: 39.8912, 32.7801");
                return;
            }

            const newVenueData = {
                name: name,
                coords: finalCoords,
                rating: 5.0,
                reviews: 0,
                products: [{
                    name: "Ã‡ay",
                    ingredients: "Standart Bardak Ã‡ay",
                    price: 15,
                    oldPrice: 10,
                    rating: 5.0,
                    lastUpdate: "BugÃ¼n",
                    allergens: []
                }]
            };

            try {
                const docRef = await addDoc(collection(db, "venues"), newVenueData);
                alert("Mekan baÅŸarÄ±yla eklendi! ğŸ‰");
                newVenueData.firebaseId = docRef.id;
                window.venues.push(newVenueData);
                const marker = L.marker(newVenueData.coords).addTo(map);
                marker.on('click', () => { window.openPanel(newVenueData); });
                window.openPanel(newVenueData);
            } catch (error) {
                console.error(error);
                alert("Hata: " + error.message);
            }
        };

        // --- KULLANICI DURUMU DÄ°NLEYÄ°CÄ°SÄ° (DÃœZELTÄ°LDÄ°) ---
        onAuthStateChanged(auth, (user) => {
            const profileBtn = document.getElementById('mainProfileBtn');
            const panel = document.getElementById('infoPanel');

            if (user) {
                // GÄ°RÄ°Å YAPILDI
                console.log("GiriÅŸ yapÄ±ldÄ±:", user.email);
                window.currentUserEmail = user.email;

                profileBtn.innerHTML = "âœ…";
                profileBtn.style.border = "2px solid #2ecc71";

                // Admin kontrolÃ¼
                if (window.isAdmin && window.isAdmin()) {
                    document.getElementById('addVenueBtn').style.display = 'flex';
                }

                // EÄŸer giriÅŸ paneli aÃ§Ä±ksa kapat
                if (panel) panel.classList.remove('active');

            } else {
                // Ã‡IKIÅ YAPILDI
                console.log("Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±.");
                window.currentUserEmail = null;

                document.getElementById('addVenueBtn').style.display = 'none';
                profileBtn.innerHTML = '<img src="logo.png" alt="Profil" class="profile-btn-img">';
                profileBtn.style.border = "none";
            }
        });

        // --- ADMIN VE EDÄ°T FONKSÄ°YONLARI (GELÄ°ÅTÄ°RÄ°LMÄ°Å) ---
        const ADMIN_EMAILS = ["yetu.metu26@gmail.com", "ihsan1191206@gmail.com"];

        window.isAdmin = function () {
            return window.currentUserEmail && ADMIN_EMAILS.includes(window.currentUserEmail);
        };

        // 1. DÃœZENLEME MODUNU AÃ‡ (Eski Fiyat Kutusu KaldÄ±rÄ±ldÄ±)
        window.enableEditMode = (venueId) => {
            const container = document.getElementById('productsContainer');
            const venue = window.venues.find(v => v.firebaseId === venueId);
            if (!venue) return;

            let editHtml = `
                <div style="margin-bottom:10px; padding:10px; background:#fff3cd; border-radius:8px; font-size:0.9rem;">
                    âš ï¸ FiyatÄ± deÄŸiÅŸtirdiÄŸinizde, sistem ÅŸu anki fiyatÄ± otomatik olarak "Eski Fiyat" olarak kaydeder.
                </div>
            `;

            venue.products.forEach((prod, index) => {
                const allergenStr = prod.allergens ? prod.allergens.join(", ") : "";

                editHtml += `
                <div class="edit-item-box">
                    <div>
                        <label class="edit-label">ÃœrÃ¼n AdÄ±</label>
                        <input type="text" id="name-${index}" value="${prod.name}" class="edit-input">
                    </div>

                    <div>
                        <label class="edit-label">Ä°Ã§erik / AÃ§Ä±klama</label>
                        <input type="text" id="desc-${index}" value="${prod.ingredients}" class="edit-input">
                    </div>

                    <div>
                        <label class="edit-label">Alerjenler (VirgÃ¼lle ayÄ±rÄ±n)</label>
                        <input type="text" id="allergens-${index}" value="${allergenStr}" placeholder="Ã–rn: Gluten, SÃ¼t" class="edit-input">
                    </div>

                    <div>
                        <label class="edit-label">GÃ¼ncel Fiyat (â‚º)</label>
                        <input type="number" id="price-${index}" value="${prod.price}" class="edit-input" style="font-weight:bold; color:#27ae60;">
                    </div>

                    <button onclick="removeProduct('${venueId}', ${index})" class="delete-product-btn">
                        ğŸ—‘ï¸ ÃœrÃ¼nÃ¼ Sil
                    </button>
                </div>`;
            });

            editHtml += `
                <button onclick="addNewProduct('${venueId}')" 
                        style="width:100%; background:#3498db; color:white; padding:10px; border:none; border-radius:8px; font-weight:bold; margin-bottom:10px; cursor:pointer;">
                    â• YENÄ° ÃœRÃœN EKLE
                </button>

                <button onclick="saveChanges('${venueId}')" 
                        style="width:100%; background:#27ae60; color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                    ğŸ’¾ DEÄÄ°ÅÄ°KLÄ°KLERÄ° KAYDET
                </button>
                
                <button onclick="window.openPanel(window.venues.find(v => v.firebaseId === '${venueId}'))" 
                        style="width:100%; background:#95a5a6; color:white; padding:10px; border:none; border-radius:8px; margin-top:5px; cursor:pointer;">
                    Ä°ptal
                </button>
            `;
            container.innerHTML = editHtml;
        };

        // 2. YENÄ° ÃœRÃœN EKLEME (Helper Fonksiyon)
        window.addNewProduct = (venueId) => {
            const venue = window.venues.find(v => v.firebaseId === venueId);
            if (!venue) return;

            // BoÅŸ bir Ã¼rÃ¼n ÅŸablonu ekle
            venue.products.push({
                name: "Yeni ÃœrÃ¼n",
                ingredients: "",
                price: 0,
                oldPrice: 0,
                rating: 5.0,
                lastUpdate: "BugÃ¼n",
                allergens: []
            });

            // EkranÄ± yenile (Yeni kutucuk gÃ¶rÃ¼nsÃ¼n diye)
            window.enableEditMode(venueId);
        };

        // 3. ÃœRÃœN SÄ°LME (Helper Fonksiyon)
        window.removeProduct = (venueId, index) => {
            const venue = window.venues.find(v => v.firebaseId === venueId);
            if (!venue) return;

            if (confirm("Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸine emin misin?")) {
                venue.products.splice(index, 1); // Listeden sil
                window.enableEditMode(venueId);  // EkranÄ± yenile
            }
        };

        // 4. DEÄÄ°ÅÄ°KLÄ°KLERÄ° KAYDET
        window.saveChanges = async (venueId) => {
            const venue = window.venues.find(v => v.firebaseId === venueId);
            if (!venue) return;

            try {
                const newProducts = venue.products.map((prod, index) => {
                    const newName = document.getElementById(`name-${index}`).value;
                    const newDesc = document.getElementById(`desc-${index}`).value;
                    const enteredPrice = Number(document.getElementById(`price-${index}`).value); // Sadece bunu alÄ±yoruz

                    // Alerjenleri iÅŸle
                    const allergensInput = document.getElementById(`allergens-${index}`).value;
                    const newAllergens = allergensInput.split(',')
                        .map(s => s.trim())
                        .filter(s => s.length > 0);

                    // --- OTOMATÄ°K ESKÄ° FÄ°YAT MANTIÄI ---
                    let lastUpdate = prod.lastUpdate;

                    // VarsayÄ±lan olarak eski fiyat, veritabanÄ±ndaki neyse o kalsÄ±n.
                    let finalOldPrice = prod.oldPrice;

                    // Ama eÄŸer admin yeni bir fiyat girdiyse:
                    if (enteredPrice !== prod.price) {
                        // Åu anki gÃ¼ncel fiyatÄ±, "Eski Fiyat" olarak sakla
                        finalOldPrice = prod.price;

                        const today = new Date();
                        lastUpdate = today.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                    } else if (newName !== prod.name) {
                        // Fiyat deÄŸiÅŸmedi ama isim deÄŸiÅŸtiyse de tarihi gÃ¼ncelle
                        const today = new Date();
                        lastUpdate = today.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                    }

                    return {
                        ...prod,
                        name: newName,
                        ingredients: newDesc,
                        price: enteredPrice,
                        oldPrice: finalOldPrice, // Hesaplanan deÄŸer
                        allergens: newAllergens,
                        lastUpdate: lastUpdate
                    };
                });

                // Firestore'a gÃ¶nder
                const venueRef = doc(db, "venues", venueId);
                await updateDoc(venueRef, { products: newProducts });

                alert("MenÃ¼ gÃ¼ncellendi! âœ…");

                // Yerel veriyi gÃ¼ncelle ve paneli normal moda dÃ¶ndÃ¼r
                venue.products = newProducts;
                window.openPanel(venue);

            } catch (error) {
                console.error(error);
                alert("Hata oluÅŸtu: " + error.message);
            }
        };

        // --- VERÄ°LERÄ° Ã‡EKME FONKSÄ°YONU ---
        async function mekanlariGetir() {
            console.log("Veriler Ã§ekiliyor...");
            const querySnapshot = await getDocs(collection(db, "venues"));
            const gelenMekanlar = [];

            querySnapshot.forEach((doc) => {
                const veri = doc.data();
                veri.firebaseId = doc.id;
                gelenMekanlar.push(veri);

                if (veri.coords) {
                    const marker = L.marker(veri.coords).addTo(map);
                    marker.on('click', () => {
                        if (window.openPanel) window.openPanel(veri);
                        map.panTo([veri.coords[0] - 0.002, veri.coords[1]]);
                    });
                }
            });

            window.venues = gelenMekanlar;
            console.log("Mekanlar yÃ¼klendi ve haritaya iÅŸlendi.");
        }

        mekanlariGetir();
        console.log("Firebase, Auth ve Database hazÄ±r.");
    </script>
</body>
</html>